$('#destination_form_dialog').html('<%= escape_javascript(render 'form.html') %>');
$('#destination_form_dialog').dialog({
  modal: true,
  width: 800,
  height: 700,
  open: function() {
    <%= gmap :destination_select_map, @center_position[:latitude], @center_position[:longitude], @center_position[:zoom] %>
  }
});
$('#spot_search_form').bind('ajax:success', function() {
  if (mtp.maps['destination_select_map'].markers) {
    $.each(mtp.maps['destination_select_map'].markers, function(index, marker) {
      marker.setMap(null);
    });
  }
  mtp.maps['destination_select_map'].markers = new Array();
  $('#search_results option').each(function(index, spot) {
    var marker = new google.maps.Marker({
      position: new google.maps.LatLng($(spot).attr('mtp-latitude'), $(spot).attr('mtp-longitude')),
      map: mtp.maps['destination_select_map']
    });
    marker.selectOption = spot;
    google.maps.event.addListener(marker, 'click', function(){
      $('#new_destination input,#new_destination button,#new_destination textarea').removeAttr('disabled');
      $('#destination_spot_id').val($(marker.selectOption).val());
      $('#search_results').val($(marker.selectOption).val());
    });
    mtp.maps['destination_select_map'].markers.push(marker);
  });
});
$('#spot_search_form').bind('ajax:before', function() {
  $('#new_destination input,#new_destination button,#new_destination textarea').attr({disabled: 'disabled'});
});
$('#new_destination input,#new_destination button,#new_destination textarea').attr({disabled: 'disabled'});
$('#search_results').bind('change', function() {
  var spot = $('#search_results option:selected');
  $('#new_destination input,#new_destination button,#new_destination textarea').removeAttr('disabled');
  $('#destination_spot_id').val($(this).val());
  mtp.maps['destination_select_map'].setCenter(new google.maps.LatLng($(spot).attr('mtp-latitude'), $(spot).attr('mtp-longitude')));
});
<%- unless @destination.new_record? -%>
mtp.maps['destination_select_map'].currentMarker = new google.maps.Marker({
  position: new google.maps.LatLng('<%= escape_javascript @destination.spot.latitude %>', '<%= escape_javascript @destination.spot.longitude %>'),
  map: mtp.maps['destination_select_map']
});
<%- end -%>
